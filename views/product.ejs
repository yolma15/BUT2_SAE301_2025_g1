<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/css/product.css" /> <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&family=Medula+One&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <title><%= produit.marque %> <%= produit.modele %></title>
</head>

<body>

  <%- include('header'); %>

  <% 
    let imagePath = "https://placehold.co/600x600?text=No+Image"; // Image par défaut
    if (produit.img) {
        if (produit.img.startsWith('img/') || produit.img.startsWith('http')) {
            imagePath = "/" + produit.img;
        } else {
            imagePath = "/uploads/" + produit.img;
        }
    }
  %>

  <main>
    <div class="gauche">
      <div class="G_img">
        <span><i class="fa-solid fa-chevron-left"></i></span>
        <img src="<%= imagePath %>" alt="<%= produit.modele %>" id="mainDisplayImg" />
        <span><i class="fa-solid fa-chevron-right"></i></span>
      </div>

      <div class="P_img">
        <img src="<%= imagePath %>" class="thumb-img active" alt="Vue 1" />
        <img src="<%= imagePath %>" class="thumb-img" alt="Vue 2" />
        <img src="<%= imagePath %>" class="thumb-img" alt="Vue 3" />
      </div>
    </div>

    <div class="droite">
      <h1><%= produit.marque %> <%= produit.modele %></h1>
      
      <p style="color: #888; margin-bottom: 10px; font-weight: 500;"><%= produit.type %></p>
      
      <h2 class="prix"><%= produit.prix_location %> € <span style="font-size: 0.6em; color: #666;">/ jour</span></h2>
      
      <p class="description">
        <%= produit.description || "Aucune description disponible pour ce produit." %>
      </p>

      <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

      <form action="/locations/create" method="POST" class="rental-form">
          <input type="hidden" name="produit_id" value="<%= produit.id %>">
          
          <div class="date-inputs" style="display: flex; gap: 10px; margin-bottom: 15px;">
              <div style="flex: 1;">
                  <label for="start" style="display: block; font-size: 0.9em; margin-bottom: 5px;">Début</label>
                  <input type="date" name="date_debut" id="start" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
              <div style="flex: 1;">
                  <label for="end" style="display: block; font-size: 0.9em; margin-bottom: 5px;">Fin</label>
                  <input type="date" name="date_retour_prevue" id="end" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
          </div>

          <% if (isLoggedIn) { %>
              <% if (produit.etat === 'disponible') { %>
                  <button type="submit" style="width: 100%; background: #FD5035; color: white; border: none; padding: 15px; border-radius: 30px; font-size: 1.2rem; cursor: pointer; font-family: 'Lexend';">
                      Louer ce produit
                  </button>
              <% } else { %>
                  <button type="button" disabled style="width: 100%; background: #ccc; color: #666; border: none; padding: 15px; border-radius: 30px; font-size: 1.2rem; cursor: not-allowed; font-family: 'Lexend';">
                      Actuellement indisponible
                  </button>
              <% } %>
          <% } else { %>
              <a href="/login" style="display: block; text-align: center; width: 100%; background: #333; color: white; text-decoration: none; padding: 15px; border-radius: 30px; font-size: 1.1rem; font-family: 'Lexend';">
                  Connectez-vous pour louer
              </a>
          <% } %>
      </form>

    </div>
  </main>

  <%- include('footer'); %>

</body>

<script>
  const mainImage = document.getElementById('mainDisplayImg');
  const thumbnails = document.querySelectorAll('.P_img img');
  const leftArrow = document.querySelector('.fa-chevron-left');
  const rightArrow = document.querySelector('.fa-chevron-right');

  // On récupère l'image unique depuis la BDD injectée par EJS
  const dbImage = "<%= imagePath %>";
  
  // Comme la BDD n'a qu'une seule image pour l'instant, on crée un tableau avec la même image
  // pour simuler le carrousel sans casser ton design.
  const images = [dbImage, dbImage, dbImage];

  let currentIndex = 0;

  // Mettre à jour l'image principale
  function updateMainImage(index) {
    currentIndex = index;
    mainImage.src = images[currentIndex];
    
    // Style bordure rouge sur la miniature active
    thumbnails.forEach((thumb, i) => {
      if (i === currentIndex) {
          thumb.style.border = '2px solid #FD5035';
          thumb.style.opacity = '1';
      } else {
          thumb.style.border = '1px solid transparent';
          thumb.style.opacity = '0.7';
      }
    });
  }

  // Cliquer sur les flèches
  leftArrow.addEventListener('click', () => {
    const nextIndex = (currentIndex - 1 + images.length) % images.length;
    updateMainImage(nextIndex);
  });

  rightArrow.addEventListener('click', () => {
    const nextIndex = (currentIndex + 1) % images.length;
    updateMainImage(nextIndex);
  });

  // Cliquer sur une miniature
  thumbnails.forEach((thumb, i) => {
    thumb.addEventListener('click', () => {
      updateMainImage(i);
    });
  });

  // Initialiser
  updateMainImage(0);

  // --- Petit script pour la validation des dates ---
  const startInput = document.getElementById('start');
  const endInput = document.getElementById('end');

  // Empêcher de sélectionner une date passée
  const today = new Date().toISOString().split('T')[0];
  if(startInput) startInput.setAttribute('min', today);

  if(startInput && endInput) {
      startInput.addEventListener('change', function() {
          // La date de fin doit être après la date de début
          endInput.setAttribute('min', this.value);
      });
  }
</script>

</html>