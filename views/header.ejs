<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Locfit</title>
    <link rel="stylesheet" href="/css/header.css" />
</head>

<body>
    <div class="header-container">
        <header class="site-header">
            <a href="/home" class="Logo">
                <img src="/img/Logo blanc sur orange.png" alt="logo Locfit" />
            </a>

            <nav class="main-nav">
                <% if (isLoggedIn) { %>
                    
                    <% if (userRole === 'client') { %>
                        <a href="/home">Accueil</a>
                        <a href="/catalogue">Catalogue</a>
                        <a href="/mes-locations">Mes locations</a>
                    
                    <% } else if (userRole === 'admin') { %>
                        <a href="/home">Accueil</a>
                        <a href="/admin/inscription_agent">Tableau de bord</a>
                    
                    <% } else if (userRole === 'agent') { %>
                        <a href="/home">Accueil</a>
                        <a href="/agent/ajout_produit">Ajouts Produits</a>
                        <a href="/agent/returnprod">Retours Produits</a>
                        <a href="/agent/locations">Gestion Locations</a>
                    <% } %>

                <% } else { %>
                    <a href="/home">Accueil</a>
                    <a href="/catalogue">Catalogue</a>
                    <a href="/login">Mes locations</a>
                <% } %>
            </nav>

            <div class="user-area">
                <% if (!isLoggedIn) { %>
                    <a class="btn btn-login" href="/login">Se connecter</a>
                    <a class="btn btn-register" href="/register">S’inscrire</a>
                <% } else { %>
                    <div class="user-menu">
                        
                        <% 
                            // Logique de protection :
                            let avatarSrc = '/img/avatar-default.png';
                            if (typeof userImg !== 'undefined' && userImg) {
                                avatarSrc = '/img/' + userImg;
                            }
                        %>

                        <img class="avatar" 
                            src="<%= avatarSrc %>" 
                            alt="profil" 
                            style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" />

                        <span class="username"><%= typeof username !== 'undefined' ? username : 'Utilisateur' %></span>

                        <div class="dropdown">
                            <button class="dropdown-toggle" aria-haspopup="true" aria-expanded="false">
                                ▾
                            </button>
                            
                            <div class="dropdown-menu" role="menu">
                                <% if (userRole === 'client') { %>
                                    <a href="/profil" class="dropdown-item">Mes informations</a>
                                    <form action="/logout" method="post">
                                        <button type="submit" class="dropdown-item danger">
                                            Se déconnecter
                                        </button>
                                    </form>
                                <% } else { %>
                                    <form action="/logout" method="post">
                                        <button type="submit" class="dropdown-item danger">
                                            Se déconnecter
                                        </button>
                                    </form>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
        </header>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userMenu = document.querySelector('.user-menu');
            
            if (!userMenu) return; 

            // 1. Gérer l'ouverture/fermeture au clic sur le menu utilisateur complet
            userMenu.addEventListener('click', function(event) {
                // Si l'utilisateur clique sur un lien de déconnexion, laisser l'action se faire.
                if (event.target.closest('.dropdown-item')) {
                    return; 
                }
                
                // Empêcher la propagation pour ne pas déclencher immédiatement le document listener de fermeture
                event.stopPropagation();
                
                // Basculer la classe 'open'
                userMenu.classList.toggle('open');
            });

            // 2. Gérer la fermeture lorsque l'utilisateur clique n'importe où ailleurs sur la page
            document.addEventListener('click', function(event) {
                // Vérifier si l'élément cliqué n'est pas à l'intérieur du .user-menu
                if (userMenu.classList.contains('open') && !userMenu.contains(event.target)) {
                    userMenu.classList.remove('open');
                }
            });

            // 3. Empêcher le menu de se fermer si l'on clique à l'intérieur (mais pas sur un lien)
            const dropdownMenu = userMenu.querySelector('.dropdown-menu');
            if (dropdownMenu) {
                dropdownMenu.addEventListener('click', function(event) {
                    if (!event.target.closest('a') && event.target.tagName !== 'BUTTON') {
                        event.stopPropagation();
                    }
                });
            }
        });
    </script>
</body>

</html>