<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Locfit</title>
    <link rel="stylesheet" href="/css/header.css" />
</head>

<body>
    <div class="header-container">
        <header class="site-header">
            <a href="/home" class="Logo">
                <img src="/img/Logo blanc sur orange.png" alt="logo Locfit" />
            </a>

            <nav class="main-nav">
                <% if (isLoggedIn) { %>
                    
                    <% if (userRole === 'client') { %>
                        <a href="/home">Accueil</a>
                        <a href="/catalogue">Catalogue</a>
                        <a href="/mes-locations">Mes locations</a>
                    
                    <% } else if (userRole === 'admin') { %>
                        <a href="/home">Accueil</a>
                        <a href="/inscription_agent">Tableau de bord</a>
                    
                    <% } else if (userRole === 'agent') { %>
                        <a href="/home">Accueil</a>
                        <a href="/agent/ajout_produit">Ajouts Produits</a>
                        <a href="/agent/returnprod">Retours Produits</a>
                    <% } %>

                <% } else { %>
                    <a href="/home">Accueil</a>
                    <a href="/catalogue">Catalogue</a>
                    <a href="/login">Mes locations</a>
                <% } %>
            </nav>

            <div class="user-area">
                <% if (!isLoggedIn) { %>
                    <a class="btn btn-login" href="/login">Se connecter</a>
                    <a class="btn btn-register" href="/register">S’inscrire</a>
                <% } else { %>
                    <div class="user-menu">
                        
                        <% 
                            // 1. Image par défaut (fall back local)
                            let avatarSrc = '/img/default.jpg';
                            
                            // 2. CORRECTION : On utilise le chemin /img/ pour les images BDD,
                            // car c'est le chemin qui fonctionne sur la page profil.
                            if (typeof userImg !== 'undefined' && userImg && userImg !== 'null' && userImg.trim() !== '') {
                                avatarSrc = '/img/' + userImg; // Chemin corrigé pour correspondre à /profil
                            }
                        %>

                        <img class="avatar" 
                             src="<%= avatarSrc %>" 
                             alt="profil" 
                             
                             onerror="this.onerror=null; this.src='/img/default.jpg';"
                             
                            >

                        <span class="username"><%= typeof username !== 'undefined' ? username : 'Utilisateur' %></span>

                        <div class="dropdown">
                            <button class="dropdown-toggle" aria-haspopup="true" aria-expanded="false">
                                ▾
                            </button>
                            
                            <div class="dropdown-menu" role="menu">
                                <% if (userRole === 'client') { %>
                                    <a href="/profil" class="dropdown-item">Mes informations</a>
                                    <form action="/logout" method="post">
                                        <button type="submit" class="dropdown-item danger">
                                            Se déconnecter
                                        </button>
                                    </form>
                                <% } else { %>
                                    <form action="/logout" method="post">
                                        <button type="submit" class="dropdown-item danger">
                                            Se déconnecter
                                        </button>
                                    </form>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
        </header>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userMenu = document.querySelector('.user-menu');
            
            if (!userMenu) return; 

            // 1. Gérer l'ouverture au clic
            userMenu.addEventListener('click', function(event) {
                if (event.target.closest('.dropdown-item')) {
                    return; 
                }
                event.stopPropagation();
                userMenu.classList.toggle('open');
            });

            // 2. Fermer si clic ailleurs
            document.addEventListener('click', function(event) {
                if (userMenu.classList.contains('open') && !userMenu.contains(event.target)) {
                    userMenu.classList.remove('open');
                }
            });

            // 3. Empêcher fermeture si clic dans le dropdown
            const dropdownMenu = userMenu.querySelector('.dropdown-menu');
            if (dropdownMenu) {
                dropdownMenu.addEventListener('click', function(event) {
                    if (!event.target.closest('a') && event.target.tagName !== 'BUTTON') {
                        event.stopPropagation();
                    }
                });
            }
        });
    </script>
</body>
</html>