<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion des Retours</title>
    <link rel="stylesheet" href="/css/returnprod.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body>
    <%- include('header'); %>

    <div class="titre">
        <h1>Retours en attente (<%= locations.length %>)</h1>
    </div>

    <div class="main">
        
        <div class="returns-grid">
            
            <% if (locations.length === 0) { %>
                <div class="no-returns">
                    <i class="fa-solid fa-clipboard-check"></i>
                    <p>Aucun produit en cours de location.</p>
                    <small>Tout le matériel a été rendu.</small>
                </div>
            <% } %>

            <% locations.forEach(loc => { 
                // Calcul du retard pour affichage visuel
                const today = new Date();
                const due = new Date(loc.date_retour_prevue);
                const isLate = today.setHours(0,0,0,0) > due.setHours(0,0,0,0);
            %>
                <div class="return-card" id="card-<%= loc.id %>">
                    
                    <div class="card-header">
                        
                        <div class="img-container">
                            <% if (loc.img) { %>
                                <% if (loc.img.startsWith('img/') || loc.img.startsWith('http')) { %>
                                    <img src="/<%= loc.img %>" class="prod-img" alt="Produit">
                                <% } else { %>
                                    <img src="/uploads/<%= loc.img %>" class="prod-img" alt="Produit">
                                <% } %>
                            <% } else { %>
                                <img src="https://placehold.co/60x60?text=No+Img" class="prod-img" alt="Image par défaut">
                            <% } %>
                        </div>

                        <div class="prod-info">
                            <h3><%= loc.marque %> <%= loc.modele %></h3>
                            <p>Loc #<%= loc.id %> • <span style="font-weight:500; color:#FD5035"><%= loc.prix_total %> €</span></p>
                        </div>
                    </div>

                    <div class="client-info">
                        <i class="fa-solid fa-user" style="color: #FD5035;"></i> 
                        <strong><%= loc.prenom %> <%= loc.nom %></strong><br>
                        <small style="color:#666; margin-left: 18px;"><%= loc.email %></small>
                    </div>

                    <div class="dates-info">
                        <div style="line-height: 1.2;">
                            <span style="font-size: 0.8rem; color: #888;">RETOUR PRÉVU :</span><br>
                            <strong><%= new Date(loc.date_retour_prevue).toLocaleDateString('fr-FR') %></strong>
                        </div>
                        
                        <% if (isLate) { %>
                            <span class="late-badge">
                                <i class="fa-solid fa-triangle-exclamation"></i> En retard
                            </span>
                        <% } else { %>
                            <span style="color: #27ae60; font-weight: 600; font-size: 0.9rem;">
                                <i class="fa-regular fa-clock"></i> À l'heure
                            </span>
                        <% } %>
                    </div>

                    <div class="action-area">
                        <div class="input-wrapper">
                            <input type="number" 
                                   id="cout-<%= loc.id %>" 
                                   class="input-cout" 
                                   placeholder="Surcoût éventuel (€)" 
                                   min="0" 
                                   step="0.01">
                        </div>
                        
                        <button class="btn-validate" onclick="validerRetour(<%= loc.id %>)">
                            <i class="fa-solid fa-check"></i> Valider
                        </button>
                    </div>

                </div>
            <% }) %>

        </div>
    </div>

    <%- include('footer'); %>

    <script>
        async function validerRetour(id) {
            const inputCout = document.getElementById('cout-' + id);
            const surcout = parseFloat(inputCout.value) || 0;
            const card = document.getElementById('card-' + id);

            if (!confirm(`Confirmer le retour de la location #${id} ?\n(Surcoût appliqué : ${surcout} €)`)) {
                return;
            }

            try {
                const response = await fetch(`/agent/finaliser_location/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ surcout: surcout })
                });

                const data = await response.json();

                if (data.success) {
                    card.style.opacity = "0";
                    card.style.transform = "scale(0.9)";
                    
                    setTimeout(() => {
                        card.remove();
                        const grid = document.querySelector('.returns-grid');
                        if (grid.children.length === 0) {
                            grid.innerHTML = `
                                <div class="no-returns">
                                    <i class="fa-solid fa-clipboard-check"></i>
                                    <p>Plus aucun retour en attente.</p>
                                </div>`;
                        }
                        alert(`✅ Retour validé avec succès !\nPrix final : ${data.prix_final.toFixed(2)} €`);
                    }, 500);
                } else {
                    alert('❌ Erreur : ' + data.error);
                }

            } catch (err) {
                console.error(err);
                alert('❌ Erreur de communication avec le serveur.');
            }
        }
    </script>
</body>
</html>