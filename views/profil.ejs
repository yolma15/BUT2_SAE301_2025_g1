<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mon Profil - <%= utilisateur.login %></title>
    <!-- Le style est géré par ce lien CSS externe -->
    <link rel="stylesheet" href="/css/profil.css" />

    <!-- Liens pour les polices -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&family=Medula+One&display=swap"
        rel="stylesheet" />

    <!-- Lien pour Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    
</head>

<body>
    <!-- Inclusion de l'en-tête -->
    <%- include('header'); %>

    <main>
        <%
            // Fonction utilitaire pour formater la date en YYYY-MM-DD
            function formatDate(dateString) {
                if (!dateString) return '';
                try {
                    const date = (dateString instanceof Date) ? dateString : new Date(dateString); 
                    if (isNaN(date.getTime())) return '';
                    return date.toISOString().substring(0, 10);
                } catch (e) {
                    return '';
                }
            }
            
            // Affichage des messages de session
            const profilMessage = typeof message !== 'undefined' ? message : null;
            
            // Valeur fixe d'astérisques pour le mode lecture seule
            const SECURE_PASSWORD_DISPLAY = '********';
        %>

        <!-- Bloc de profil (Header) -->
        <div class="profile-card profile-header">
            <img class="profil-image"
                src="<%= utilisateur.photo_url || 'https://placehold.co/300x300/e0e0e0/333?text=Profil' %>"
                alt="Image de profil">
            <h1>
                <%= utilisateur.login %>
            </h1>
        </div>

        <!-- Affichage des messages de succès/erreur -->
        <% if (profilMessage) { %>
            <div class="message-box profile-card <%= profilMessage.type === 'success' ? 'success' : 'error' %>">
                <%= profilMessage.text %>
            </div>
        <% } %>

        <!-- Section de modification des informations personnelles -->
        <!-- NOTE: Cette route POST doit gérer la mise à jour des champs ddn, nom, prenom, email, ET password -->
        <form id="profile-form" action="/profil/informations" method="POST" class="profile-card info-section">
            <h2>Mes informations</h2>

            <div class="field-group-container">
                <div class="field-group">
                    <label for="nom">Nom :</label>
                    <input type="text" id="nom" name="nom" value="<%= utilisateur.nom || '' %>" required readonly>
                </div>
            </div>

            <div class="field-group-container">
                <div class="field-group">
                    <label for="prenom">Prénom :</label>
                    <input type="text" id="prenom" name="prenom" value="<%= utilisateur.prenom || '' %>" required readonly>
                </div>
            </div>

            <div class="field-group-container">
                <div class="field-group">
                    <label for="email">Email :</label>
                    <input type="email" id="email" name="email" value="<%= utilisateur.email || '' %>" required readonly>
                </div>
            </div>

            <div class="field-group-container">
                <div class="field-group">
                    <label for="ddn">Anniversaire :</label>
                    <input type="date" id="ddn" name="ddn" value="<%= formatDate(utilisateur.ddn) %>" readonly>
                </div>
            </div>
            
            <!-- LIGNE POUR LE MOT DE PASSE (format unifié) -->
            <div class="field-group-container">
                <div class="field-group">
                    <label for="password">Mot de passe :</label>
                    <!-- Affichage initial : Astérisques fixes. -->
                    <input type="password" id="password" name="password" 
                        value="<%= SECURE_PASSWORD_DISPLAY %>" 
                        placeholder="Laisser vide pour ne pas changer" 
                        readonly>
                </div>
            </div>
            
            <!-- Boutons de contrôle du formulaire d'informations -->
            <div class="edit-controls">
                <!-- Bouton "Modifier" affiché par défaut -->
                <button type="button" id="edit-button" class="save-button" onclick="toggleEditMode()">
                    <i class="fa-solid fa-pen"></i> Modifier
                </button>

                <!-- Bouton "Sauvegarder" masqué par défaut -->
                <button type="submit" id="save-button" class="save-button" style="display: none;">
                    <i class="fa-solid fa-save"></i> Sauvegarder les modifications
                </button>
                
                <!-- Bouton Annuler (apparaît avec Sauvegarder) -->
                <button type="button" id="cancel-button" class="annuler-button" onclick="toggleEditMode(true)" style="display: none;">
                    Annuler
                </button>
            </div>
        </form>
        
        <!-- Bouton pour supprimer le compte -->
        <div class="profile-card delete-section">
            <button class="supp">Supprimer le compte</button>
        </div>

    </main>
    
    <script>
        // Stocker les valeurs originales des inputs non-password
        let originalValues = {};
        const SECURE_PASSWORD_DISPLAY = '********'; // Doit correspondre à la constante EJS

        /**
         * Bascule le mode lecture seule/édition pour le formulaire d'informations personnelles.
         * @param {boolean} isCancel - Vrai si l'action est un annulation, Faux sinon.
         */
        function toggleEditMode(isCancel = false) {
            const form = document.getElementById('profile-form');
            const inputs = form.querySelectorAll('input');
            const editButton = document.getElementById('edit-button');
            const saveButton = document.getElementById('save-button');
            const cancelButton = document.getElementById('cancel-button');
            const passwordInput = document.getElementById('password');

            const isReadonly = inputs[0].readOnly;

            if (isReadonly) {
                // Passage en mode édition
                inputs.forEach(input => {
                    input.removeAttribute('readonly');
                    if (input.id !== 'password') {
                        // Stocker les valeurs actuelles (avant l'édition)
                        originalValues[input.id] = input.value;
                    }
                });
                
                // Vider le champ mot de passe et utiliser le placeholder
                passwordInput.value = '';

                editButton.style.display = 'none';
                saveButton.style.display = 'block';
                cancelButton.style.display = 'block';
                
            } else {
                // Revenir en mode lecture seule (SAUVEGARDER OU ANNULER)
                inputs.forEach(input => {
                    if (isCancel && input.id !== 'password') {
                        // Annuler: Restaurer les valeurs originales pour les champs non-password
                        input.value = originalValues[input.id] || '';
                    }
                    input.setAttribute('readonly', true);
                });
                
                // Rétablir l'affichage sécurisé du mot de passe
                passwordInput.value = SECURE_PASSWORD_DISPLAY;
                
                editButton.style.display = 'block';
                saveButton.style.display = 'none';
                cancelButton.style.display = 'none';
            }
        }
        
        // Initialisation: S'assurer que tout est en lecture seule au chargement
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('profile-form');
            const inputs = form.querySelectorAll('input');

            // 1. Initialiser le formulaire d'informations personnelles en lecture seule
            inputs.forEach(input => {
                input.setAttribute('readonly', true);
            });
            // Assurer le bon état initial des boutons
            document.getElementById('edit-button').style.display = 'block';
            document.getElementById('save-button').style.display = 'none';
            document.getElementById('cancel-button').style.display = 'none';
        });
    </script>

    <!-- Inclusion du pied de page -->
    <%- include('footer'); %>
</body>

</html>