<!DOCTYPE html>
<html lang="fr">
<head> 
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mes locations</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/mes_locations.css" />
</head>

<body>
<%- include('header') %>

<main class="container">
  <h1>Mes Locations</h1>

  <% if (typeof message !== 'undefined' && message) { %>
    <div class="alert-message" role="alert">
      <p><%= message %></p>
    </div>
  <% } %>

  <% if (locations.length === 0) { %>
    <div class="empty-locations">
      <p>Vous n'avez aucune location en cours.</p>
      <a href="/catalogue" class="btn-primary">
        D√©couvrir le catalogue
      </a>
    </div>

  <% } else { %>
    <div class="locations-grid">
      <% locations.forEach(location => { %>
        <% 
          const now = new Date();
          const dateDebut = new Date(location.date_debut);
          const dateRetourPrevue = new Date(location.date_retour_prevue);
          
          // V√©rification si la date est pass√©e
          const isTimePassed = now > dateRetourPrevue;

          // On peut annuler SEULEMENT si la location n'a pas encore commenc√©
          const peutAnnuler = dateDebut > now;
        %>
        
        <div class="location-card">
          
          <div class="location-card-header">
            <div class="location-main-info">
              <h3><%= location.marque %> <%= location.modele %></h3>
              <p><span style="font-weight:600;">Type:</span> <%= location.type %></p>
            </div>
            
            <div class="location-price">
              <span class="location-price-value"><%= location.prix_total.toFixed(2) %> ‚Ç¨</span>
              <span class="location-price-label">Prix total</span>
            </div>
          </div>

          <div class="location-card-divider">
            <div class="location-details-grid">
              
              <div class="location-details-item">
                <p class="label">Date de d√©but</p>
                <p class="value"><%= new Date(location.date_debut).toLocaleDateString('fr-FR') %></p>
              </div>
              
              <div class="location-details-item">
                <p class="label">Retour pr√©vu</p>
                <p class="value"><%= new Date(location.date_retour_prevue).toLocaleDateString('fr-FR') %></p>
              </div>
              
              <div class="location-details-item">
                <p class="label">Statut</p>
                
                <% if (isTimePassed) { %>
                    <span class="status-pill status-pill--pending">
                        ‚è≥ En attente de validation
                    </span>
                <% } else { %>
                    <span class="status-pill status-pill--ongoing">
                        üìã En cours
                    </span>
                <% } %>

              </div>

            </div>

            <div class="location-actions" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                
                <% if (peutAnnuler) { %>
                  <button onclick="annulerReservation(<%= location.id %>)" 
                          class="btn-cancel-custom">
                    ‚ùå Annuler
                  </button>
                <% } %>

                <% if (isTimePassed) { %>
                     <span style="font-size: 0.8rem; color: #e67e22; font-weight: 500;">
                        Veuillez rapporter le produit en magasin.
                     </span>
                <% } else { %>
                    <a href="/returnprod?location_id=<%= location.id %>" class="btn-success">
                        Signaler le retour
                    </a>
                <% } %>

            </div>

          </div>
        </div>
      <% }); %>
    </div>
  <% } %>
</main>

<script>
async function annulerReservation(locationId) {
  if (!confirm("‚ö†Ô∏è √ätes-vous s√ªr de vouloir annuler cette r√©servation ?\n\nCette action est irr√©versible.")) {
    return;
  }

  try {
    const response = await fetch(`/locations/cancel/${locationId}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    });

    const data = await response.json();

    if (data.success) {
      alert("‚úÖ " + data.message);
      window.location.reload();
    } else {
      alert("‚ùå " + data.error);
    }
  } catch (error) {
    console.error("Erreur:", error);
    alert("‚ùå Une erreur est survenue lors de l'annulation");
  }
}
</script>

<%- include('footer') %>
</body>
</html>