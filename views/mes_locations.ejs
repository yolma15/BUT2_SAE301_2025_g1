<!DOCTYPE html>
<html lang="fr">
<head> 
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mes locations</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/mes_locations.css" />
</head>

<body>
<%- include('header') %>

<main class="container">
  <h1>Mes Locations</h1>

  <% if (typeof message !== 'undefined' && message) { %>
    <div class="alert-message" role="alert">
      <p><%= message %></p>
    </div>
  <% } %>

  <% if (locations.length === 0) { %>
    <div class="empty-locations">
      <p>Vous n'avez aucune location en cours.</p>
      <a href="/catalogue" class="btn-primary">
        Découvrir le catalogue
      </a>
    </div>

  <% } else { %>
    <div class="locations-grid">
      <% locations.forEach(location => { %>
        <% 
          const now = new Date();
          const dateDebut = new Date(location.date_debut);
          const dateRetourPrevue = new Date(location.date_retour_prevue);
          
          
          const isTimePassed = now.setHours(0,0,0,0) > dateRetourPrevue.setHours(0,0,0,0);

          const peutAnnuler = dateDebut > new Date(); 
        %>
        
        <div class="location-card">
          
          <div class="location-card-header">
            <div class="location-main-info">
              <h3><%= location.marque %> <%= location.modele %></h3>
              <p><span style="font-weight:600;">Type:</span> <%= location.type %></p>
            </div>
            
            <div class="location-price">
              <span class="location-price-value"><%= location.prix_total.toFixed(2) %> €</span>
              <span class="location-price-label">Prix total</span>
            </div>
          </div>

          <div class="location-card-divider">
            <div class="location-details-grid">
              
              <div class="location-details-item">
                <p class="label">Date de début</p>
                <p class="value"><%= new Date(location.date_debut).toLocaleDateString('fr-FR') %></p>
              </div>
              
              <div class="location-details-item">
                <p class="label">Retour prévu</p>
                <p class="value"><%= new Date(location.date_retour_prevue).toLocaleDateString('fr-FR') %></p>
              </div>
              
              <div class="location-details-item">
                <p class="label">Statut</p>
                
                <% if (isTimePassed) { %>
                    <span class="status-pill status-pill--late">
                        En attente de retour
                    </span>
                <% } else { %>
                    <span class="status-pill status-pill--ongoing">
                      En cours
                    </span>
                <% } %>

              </div>

            </div>

            <div class="location-actions" >
                
                <% if (peutAnnuler) { %>
                  <button onclick="annulerReservation(<%= location.id %>)" 
                          class="btn-cancel-custom">
                    Annuler
                  </button>
                <% } %>

                <% if (isTimePassed) { %>
                     <div >
                        Date dépassée.<br>Veuillez rapporter le matériel.
                     </div>
                <% } else { %>
                    <div >
                        Location active
                    </div>
                <% } %>

            </div>

          </div>
        </div>
      <% }); %>
    </div>
  <% } %>
</main>

<script>
async function annulerReservation(locationId) {
  if (!confirm("Êtes-vous sûr de vouloir annuler cette réservation ?\n\nCette action est irréversible.")) {
    return;
  }

  try {
    const response = await fetch(`/locations/cancel/${locationId}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    });

    const data = await response.json();

    if (data.success) {
      alert(data.message);
      window.location.reload();
    } else {
      alert(data.error);
    }
  } catch (error) {
    console.error("Erreur:", error);
    alert("Une erreur est survenue lors de l'annulation");
  }
}
</script>

<%- include('footer') %>
</body>
</html>