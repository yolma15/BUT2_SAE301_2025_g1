<%- include('header') %>

<main class="container" style="padding: 2rem">
  <h1>üìã Gestion des locations</h1>

  <% if (message) { %>
  <div class="alert"><%= message %></div>
  <% } %> 
  <% if (locations.length === 0) { %>
  <p>Aucune location enregistr√©e.</p>
  <% } else { %>
  <table style="width: 100%; border-collapse: collapse; margin-top: 1rem">
    <thead>
      <tr style="background-color: var(--color-secondary); text-align: left">
        <th style="padding: 0.75rem; border: 1px solid var(--color-border)">
          #
        </th>
        <th style="padding: 0.75rem; border: 1px solid var(--color-border)">
          Client
        </th>
        <th style="padding: 0.75rem; border: 1px solid var(--color-border)">
          Email
        </th>
        <th style="padding: 0.75rem; border: 1px solid var(--color-border)">
          Produit
        </th>
        <th style="padding: 0.75rem; border: 1px solid var(--color-border)">
          D√©but
        </th>
        <th style="padding: 0.75rem; border: 1px solid var(--color-border)">
          Retour pr√©vu
        </th>
        <th style="padding: 0.75rem; border: 1px solid var(--color-border)">
          Retour effectif
        </th>
        <th style="padding: 0.75rem; border: 1px solid var(--color-border)">
          Prix
        </th>
        <th style="padding: 0.75rem; border: 1px solid var(--color-border)">
          Actions
        </th>
      </tr>
    </thead>
    <tbody>
      <% locations.forEach(location => { %>
      <tr>
        <td style="padding: 0.75rem; border: 1px solid var(--color-border)">
          #<%= location.id %>
        </td>
        <td style="padding: 0.75rem; border: 1px solid var(--color-border)">
          <%= location.nom %> <%= location.prenom %>
        </td>
        <td style="padding: 0.75rem; border: 1px solid var(--color-border)">
          <%= location.email %>
        </td>
        <td style="padding: 0.75rem; border: 1px solid var(--color-border)">
          <%= location.type %> - <%= location.marque %> <%= location.modele %>
        </td>
        <td style="padding: 0.75rem; border: 1px solid var(--color-border)">
          <%= new Date(location.date_debut).toLocaleDateString('fr-FR') %>
        </td>
        <td style="padding: 0.75rem; border: 1px solid var(--color-border)">
          <%= new Date(location.date_retour_prevue).toLocaleDateString('fr-FR')
          
          %>
        </td>
        <td style="padding: 0.75rem; border: 1px solid var(--color-border)">
          <% if (location.date_retour_effective) { %>
          <span style="color: var(--color-success)"
            >‚úÖ <%= new
            Date(location.date_retour_effective).toLocaleDateString('fr-FR')
            %></span
          >
          <% } else { %>
          <span style="color: var(--color-warning)">‚è≥ En cours</span>
          <% } %>
        </td>
        <td style="padding: 0.75rem; border: 1px solid var(--color-border)">
          <%= location.prix_total %> ‚Ç¨
        </td>
        <td style="padding: 0.75rem; border: 1px solid var(--color-border)">
          <% if (!location.date_retour_effective) { %>
          <button
            onclick="finaliserLocation( <%= location.id %> )"
            class="btn btn--primary"
            style="padding: 0.5rem 1rem; cursor: pointer"
          >
            ‚úÖ Finaliser
          </button>
          <% } else { %>
          <span class="status status--success">Termin√©e</span>
          <% } %>
        </td>
      </tr>
      <% }) %>
    </tbody>
  </table>
  <% } %>
</main>

<script>
  async function finaliserLocation(id) {
    if (
      !confirm(
        "‚ö†Ô∏è Confirmer la finalisation de cette location ?\n\nLe produit sera remis en disponibilit√© et les surco√ªts √©ventuels seront calcul√©s."
      )
    ) {
      return;
    }

    try {
      const res = await fetch(`/agent/finaliser_location/${id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      const data = await res.json();

      if (data.success) {
        alert(
          `‚úÖ Location finalis√©e avec succ√®s !\n\nPrix final : ${data.prix_final}‚Ç¨`
        );
        location.reload();
      } else {
        alert("‚ùå Erreur : " + data.error);
      }
    } catch (err) {
      console.error(err);
      alert("‚ùå Erreur lors de la finalisation");
    }
  }
</script>

<%- include('footer') %>
